<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقارير الدفاتر والسندات - Note Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Arial', sans-serif; }
        /* Custom styles for consistency if needed - assuming primary app theme */
        .report-section {
            border-color: #e2e8f0; /* gray-200 */
        }
        .bg-blue-50 {
            background-color: #eff6ff; /* light blue */
        }
        .text-blue-600 {
            color: #2563eb;
        }
        .hover\:bg-blue-700:hover {
            background-color: #1d4ed8;
        }
        .focus\:ring-blue-500:focus {
            --tw-ring-color: #3b82f6;
        }
        .border-blue-500 {
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div id="app" class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">تقارير الدفاتر والسندات</h2>

        <div class="flex border-b mb-6 justify-center">
            <button
                @click="activeReport = 'overview'"
                :class="{'border-b-2 border-blue-500 text-blue-600': activeReport === 'overview'}"
                class="py-3 px-6 text-gray-700 font-semibold focus:outline-none transition-colors duration-200 hover:text-blue-500"
            >
                نظرة عامة على حالة الدفاتر
            </button>
            <button
                @click="activeReport = 'missingDetails'"
                :class="{'border-b-2 border-blue-500 text-blue-600': activeReport === 'missingDetails'}"
                class="py-3 px-6 text-gray-700 font-semibold focus:outline-none transition-colors duration-200 hover:text-blue-500"
            >
                تفاصيل السندات المفقودة
            </button>
        </div>

        <div v-if="activeReport === 'overview'" class="report-section p-6 border rounded-lg shadow-sm bg-gray-50 mb-8">
            <h3 class="text-2xl font-semibold mb-4 text-gray-700">نظرة عامة على حالة الدفاتر</h3>
            <div class="filters grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-6">
                <div>
                    <label for="collectorOverview" class="block text-sm font-medium text-gray-700 mb-1">المحصل:</label>
                    <select
                        id="collectorOverview"
                        v-model="overviewFilters.collectorId"
                        class="mt-1 block w-full pl-4 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                    >
                        <option value="">كل المحصلين</option>
                        <option v-for="collector in collectors" :key="collector._id" :value="collector._id">
                            {{ collector.name }}
                        </option>
                    </select>
                </div>
                <div>
                    <label for="statusOverview" class="block text-sm font-medium text-gray-700 mb-1">الحالة:</label>
                    <select
                        id="statusOverview"
                        v-model="overviewFilters.notebookStatus"
                        class="mt-1 block w-full pl-4 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                    >
                        <option value="all">كل الحالات</option>
                        <option value="متاح">متاح</option>
                        <option value="مستخدم جزئيًا">مستخدم جزئيًا</option>
                        <option value="ممتلئ">ممتلئ</option>
                        <option value="مفقود">مفقود</option>
                    </select>
                </div>
                <div>
                    <label for="hasMissingOverview" class="block text-sm font-medium text-gray-700 mb-1">يحتوي على مفقود؟</label>
                    <select
                        id="hasMissingOverview"
                        v-model="overviewFilters.hasMissing"
                        class="mt-1 block w-full pl-4 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                    >
                        <option value="">الكل</option>
                        <option value="yes">نعم</option>
                        <option value="no">لا</option>
                    </select>
                </div>
                <div>
                    <label for="hasPendingOverview" class="block text-sm font-medium text-gray-700 mb-1">يحتوي على قيد الانتظار؟</label>
                    <select
                        id="hasPendingOverview"
                        v-model="overviewFilters.hasPending"
                        class="mt-1 block w-full pl-4 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                    >
                        <option value="">الكل</option>
                        <option value="yes">نعم</option>
                        <option value="no">لا</option>
                    </select>
                </div>
            </div>
            <button
                @click="fetchOverviewReport"
                class="px-5 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-200"
            >
                توليد التقرير
            </button>

            <div v-if="loadingOverview" class="text-center mt-6 text-blue-600">جاري التحميل...</div>
            <div v-if="overviewReport.length > 0" class="mt-6 overflow-x-auto rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">نطاق الدفتر</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">المحصل</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">العدد الكلي</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">المستخدمة</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">المفقودة</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">قيد الانتظار</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">نسبة الإنجاز</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">الحالة</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">تاريخ التحديث</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="item in overviewReport" :key="item.notebookId">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.notebookRange }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.collectorName }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.totalReceipts }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.usedReceiptsCount }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.missingReceiptsCount }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.pendingReceiptsCount }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.completionPercentage }}%</td>
                            <td :class="['px-6 py-4 whitespace-nowrap text-sm', {'text-red-600 font-medium': item.status === 'مفقود'}, {'text-green-600 font-medium': item.status === 'ممتلئ'}]">{{ item.status }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ formatDate(item.updatedAt) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div v-else-if="!loadingOverview && overviewReport.length === 0" class="mt-6 text-gray-600 text-center">لا توجد بيانات لهذا التقرير.</div>
        </div>

        <div v-if="activeReport === 'missingDetails'" class="report-section p-6 border rounded-lg shadow-sm bg-gray-50">
            <h3 class="text-2xl font-semibold mb-4 text-gray-700">تفاصيل السندات المفقودة</h3>
            <div class="filters grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="collectorMissing" class="block text-sm font-medium text-gray-700 mb-1">المحصل:</label>
                    <select
                        id="collectorMissing"
                        v-model="missingDetailsFilters.collectorId"
                        class="mt-1 block w-full pl-4 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"
                    >
                        <option value="">كل المحصلين</option>
                        <option v-for="collector in collectors" :key="collector._id" :value="collector._id">
                            {{ collector.name }}
                        </option>
                    </select>
                </div>
                <div>
                    <label for="searchTextMissing" class="block text-sm font-medium text-gray-700 mb-1">بحث في الملاحظات:</label>
                    <input
                        type="text"
                        id="searchTextMissing"
                        v-model="missingDetailsFilters.searchText"
                        placeholder="ابحث عن ملاحظات..."
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                </div>
            </div>
            <button
                @click="fetchMissingDetailsReport"
                class="px-5 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-200"
            >
                توليد التقرير
            </button>

            <div v-if="loadingMissingDetails" class="text-center mt-6 text-blue-600">جاري التحميل...</div>
            <div v-if="missingDetailsReport.length > 0" class="mt-6 overflow-x-auto rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">نطاق الدفتر</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">المحصل</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">رقم السند المفقود</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">الملاحظة</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">تاريخ الاكتشاف</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="(item, index) in missingDetailsReport" :key="index">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.notebookRange }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.collectorName }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ item.receiptNumber }}</td>
                            <td class="px-6 py-4 whitespace-normal text-sm text-gray-800">{{ item.note || 'لا توجد ملاحظة' }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ formatDate(item.discoveredAt) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div v-else-if="!loadingMissingDetails && missingDetailsReport.length === 0" class="mt-6 text-gray-600 text-center">لا توجد سندات مفقودة بهذا التقرير.</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/assets/js/note-reports-service.js"></script>
</body>
</html>