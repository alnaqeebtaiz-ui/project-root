<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقارير السندات المفقودة - نظام إدارة الفواتير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css"> 
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .report-controls-top {
            background-color: #fff; padding: 20px; border-radius: 10px;
            margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        .filters-layout {
            display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;
        }
        .data-table th, .data-table td { text-align: center; vertical-align: middle; }
        .data-table tbody tr:hover { background-color: #f5f5f5; }
        .data-table tfoot th { background-color: #f8f9fa; font-size: 1.1em; }
        .total-row th { background-color: #e9ecef; font-weight: bold; }
        .total-missing-count {
            font-size: 1.2em;
            font-weight: bold;
            color: #dc3545; /* لون أحمر للتنبيه */
            margin-top: 15px;
            text-align: center;
        }
        /* لتنسيق تاريخ الإدخال بشكل جيد */
        input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-family: 'Droid Arabic Kufi', sans-serif; /* أو الخط الذي تستخدمه */
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="page-container" id="app">
        <header class="page-header">
            <div class="container">
                <h1>تقارير السندات المفقودة</h1>
                <nav class="breadcrumb">
                    <a href="dashboard.html">لوحة التحكم</a> / <span>تقارير السندات المفقودة</span>
                </nav>
            </div>
        </header>

        <main class="page-content">
            <div class="container">
                <div class="report-controls-top">
                    <div class="filters-layout">
                        <div class="form-group">
                            <label for="collectorSelect">المحصل:</label>
                            <select id="collectorSelect" class="form-control" v-model="filters.collectorId">
                                <option value="all">كل المحصلين</option>
                                <option v-for="collector in collectors" :key="collector._id" :value="collector._id">{{ collector.name }}</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="startDateInput">من تاريخ:</label>
                            <input type="date" id="startDateInput" class="form-control" v-model="filters.startDate">
                        </div>

                        <div class="form-group">
                            <label for="endDateInput">إلى تاريخ:</label>
                            <input type="date" id="endDateInput" class="form-control" v-model="filters.endDate">
                        </div>
                        
                        <button class="btn btn-primary" @click="fetchMissingReceiptsReport" :disabled="loading">
                            <i class="fas fa-play-circle"></i> عرض التقرير
                        </button>

                        <button class="btn btn-success" @click="exportReport" :disabled="!reportData.length || loading">
                            <i class="fas fa-file-excel"></i> تصدير Excel
                        </button>
                    </div>
                </div>

                <section class="report-display">
                    <div v-if="loading" class="text-center p-4">
                        <div class="loader"></div>
                        <p class="mt-2">جاري تحميل التقرير...</p>
                    </div>
                    <div v-else-if="!reportData.length && !initialLoad" class="text-center p-4">
                        <p>لا توجد سندات مفقودة مطابقة للفلاتر المحددة.</p>
                    </div>
                    <div v-else-if="reportData.length" class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>رقم السند</th>
                                    <th>الدفتر (من - إلى)</th>
                                    <th>المحصل</th>
                                    <th>التاريخ التقديري</th>
                                    <th>الحالة</th>
                                    <th>الملاحظات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in reportData" :key="item.receiptNumber + item.collectorName">
                                    <td>{{ item.receiptNumber }}</td>
                                    <td>{{ item.notebookRange }}</td>
                                    <td>{{ item.collectorName }}</td>
                                    <td>{{ formatEstimatedDate(item.estimatedDate) }}</td>
                                    <td>{{ item.status }}</td>
                                    <td>{{ item.notes }}</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <th colspan="5">الإجمالي الكلي للسندات المفقودة</th>
                                    <th>{{ totalMissingCount }}</th>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="total-missing-count mt-3">
                            إجمالي السندات المفقودة: {{ totalMissingCount }}
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="toast" class="toast-notification"><p id="toastMessage"></p></div>
    <script type="module" src="assets/js/utils.js"></script>
    <script type="module">
        import { getCollectors, getMissingReceiptsReport, exportMissingReceiptsToExcel } from './assets/js/note-reports-service.js';
        import { showToast } from './assets/js/utils.js';

        // تهيئة Moment.js لاستخدام اللغة العربية
        moment.locale('ar-sa');

        new Vue({
            el: '#app',
            data: {
                collectors: [],
                filters: {
                    collectorId: 'all',
                    startDate: '',
                    endDate: ''
                },
                reportData: [],
                loading: false,
                initialLoad: true // لتحديد ما إذا كان أول تحميل للصفحة
            },
            computed: {
                totalMissingCount() {
                    return this.reportData.length;
                }
            },
            async created() {
                // قم بتحميل المحصلين عند إنشاء التطبيق
                await this.fetchCollectors();
                // ثم قم بتحميل التقرير الافتراضي
                await this.fetchMissingReceiptsReport();
                this.initialLoad = false;
            },
            methods: {
                async fetchCollectors() {
                    try {
                        this.collectors = await getCollectors();
                    } catch (error) {
                        console.error('Error fetching collectors:', error);
                        showToast(error.message, 'error');
                    }
                },
                async fetchMissingReceiptsReport() {
                    this.loading = true;
                    this.reportData = [];
                    try {
                        // التأكد من أن التواريخ صالحة قبل الإرسال
                        const formattedFilters = { ...this.filters };
                        if (formattedFilters.startDate) {
                            formattedFilters.startDate = moment(formattedFilters.startDate).startOf('day').toISOString();
                        }
                        if (formattedFilters.endDate) {
                            formattedFilters.endDate = moment(formattedFilters.endDate).endOf('day').toISOString();
                        }

                        this.reportData = await getMissingReceiptsReport(formattedFilters);
                    } catch (error) {
                        console.error('Error fetching missing receipts report:', error);
                        showToast(error.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                exportReport() {
                    try {
                        exportMissingReceiptsToExcel(this.reportData, 'Missing_Receipts_Report');
                        showToast('تم تصدير التقرير بنجاح.', 'success');
                    } catch (error) {
                        console.error('Error exporting report:', error);
                        showToast(error.message, 'error');
                    }
                },
                formatEstimatedDate(dateString) {
                    return dateString ? moment(dateString).format('YYYY-MM-DD') : 'N/A';
                }
            }
        });
    </script>
</body>
</html>