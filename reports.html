<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªØ­ØµÙ„ÙŠÙ† - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .report-controls-top {
            background-color: #fff; padding: 20px; border-radius: 10px;
            margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        .filters-layout {
            display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;
        }
        .filter-group { display: none; }
        .filter-group.active { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        #collectorSearchInput { width: 250px; }
        
        /* --- ADDED: Styles for the new report --- */
        .report-cycle-title {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 25px;
            margin-bottom: 10px;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        .grand-total-table {
            margin-top: 30px;
            width: 100%;
            border-collapse: collapse;
        }
        .grand-total-table th, .grand-total-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
        }
        .grand-total-table th {
            background-color: #343a40;
            color: white;
            font-size: 1.1rem;
        }
        .grand-total-table td {
            font-weight: bold;
            font-size: 1.1rem;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <div class="container">
                <h1>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ØµÙ„ÙŠÙ†</h1>
                <nav class="breadcrumb">
                    <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a> / <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </nav>
            </div>
        </header>

        <main class="page-content">
            <div class="container">
                <div class="report-controls-top">
                    <div class="filters-layout">
                        <div class="form-group">
                            <label for="reportTypeSelect"><strong>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong></label>
                            <select id="reportTypeSelect" class="form-control">
                                <option value="">-- Ø§Ø®ØªØ± --</option>
                                <option value="detailed-periodic">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</option>
                                <option value="periodic-summary-table">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ</option>
                                <option value="annual-summary">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ</option>
                            </select>
                        </div>

                        <div id="date-range-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="startDate">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="startDate" class="form-control" data-placeholder="yyyy-mm-dd">
                            </div>
                            <div class="form-group">
                                <label for="endDate">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                        </div>
                        <div id="collectors-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="collectorSearchInput">Ø§Ù„Ù…Ø­ØµÙ„:</label>
                                <input type="text" id="collectorSearchInput" class="form-control" list="collectors-list" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
                                <datalist id="collectors-list"></datalist>
                            </div>
                        </div>
                        
                        <div id="periodic-summary-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="yearFilter">Ø§Ù„Ø³Ù†Ø©:</label>
                                <select id="yearFilter" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label for="monthFilter">Ø§Ù„Ø´Ù‡Ø±:</label>
                                <select id="monthFilter" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label for="fromCycleFilter">Ù…Ù† Ø¯ÙˆØ±Ø©:</label>
                                <select id="fromCycleFilter" class="form-control">
                                    <option value="1">1</option> <option value="2">2</option> <option value="3">3</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="toCycleFilter">Ø¥Ù„Ù‰ Ø¯ÙˆØ±Ø©:</label>
                                <select id="toCycleFilter" class="form-control">
                                    <option value="1">1</option> <option value="2">2</option> <option value="3">3</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="annual-summary-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="annualYearFilter">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
                                <select id="annualYearFilter" class="form-control"></select>
                            </div>
                            <div class="form-group autocomplete-container">
                                <label for="annualCollectorFilter">Ø§Ù„Ù…Ø­ØµÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                                <input type="text" id="annualCollectorFilter" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ù„ÙƒÙ„..." class="form-control" autocomplete="off" style="width: 250px;">
                                <input type="hidden" id="annualCollectorIdFilter">
                                <div id="annualCollectorResults" class="autocomplete-results" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <button id="generateReportBtn" class="btn btn-primary" disabled><i class="fas fa-play-circle"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                        <button id="exportExcelBtn" class="btn btn-success" disabled><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
                    </div>
                </div>

                <section class="report-display">
                    <div class="table-container" id="reportTableContainer">
                        <p>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="toast" class="toast-notification"><p id="toastMessage"></p></div>

    <script type="module">
        // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯Ø§Ù„Ø© getCollectors ğŸ’¡ğŸ’¡ğŸ’¡
        import { showToast } from './assets/js/utils.js';
        import * as reportService from './assets/js/reports-service.js';
        // ğŸ’¡ğŸ’¡ğŸ’¡ Ù‡Ù†Ø§ Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯Ø§Ù„Ø© getCollectors Ù…Ù† reportService ğŸ’¡ğŸ’¡ğŸ’¡
        // Ù„Ø£Ù†Ù†Ø§ Ø£Ø¶ÙÙ†Ø§Ù‡Ø§ Ù„Ù€ reportService Ù„ÙƒÙŠ ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†
        // Ø¥Ø°Ø§ ÙƒÙ†Øª Ù‚Ø¯ ÙˆØ¶Ø¹Øª Ø¯Ø§Ù„Ø© getCollectors ÙÙŠ Ù…Ù„Ù service Ø¢Ø®Ø± ØºÙŠØ± reportServiceØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªØ³ØªÙˆØ±Ø¯Ù‡Ø§ Ù…Ù† Ù‡Ù†Ø§Ùƒ
        // ÙˆÙ„ÙƒÙ† Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù‚Ù…Ù†Ø§ Ø¨ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ reports-service.jsØŒ ÙØ³Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù…Ù† Ù‡Ù†Ø§Ùƒ
        const getCollectorsFromService = reportService.getCollectors; 


        let currentReportData = [];
        let allCollectors = [];

        // --- DOM Element References ---
        const reportTypeSelect = document.getElementById('reportTypeSelect');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const reportTableContainer = document.getElementById('reportTableContainer');
        const collectorSearchInput = document.getElementById('collectorSearchInput');
        const collectorsDatalist = document.getElementById('collectors-list');
        // --- ADDED: New filter element references ---
        const yearFilter = document.getElementById('yearFilter');
        const monthFilter = document.getElementById('monthFilter');
        const fromCycleFilter = document.getElementById('fromCycleFilter');
        const toCycleFilter = document.getElementById('toCycleFilter');

        // --- Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
        const annualYearFilter = document.getElementById('annualYearFilter');
        const annualCollectorFilterInput = document.getElementById('annualCollectorFilter');
        const annualCollectorIdFilter = document.getElementById('annualCollectorIdFilter');
        const annualCollectorResultsDiv = document.getElementById('annualCollectorResults');
        
        // --- Helper function for formatting numbers consistently ---
        function formatNumber(value) {
            return (value ?? 0).toLocaleString('en-US'); // Using en-US for English numerals as requested
        }
        
        // --- ADDED: Function to setup new filters ---
        function initializePeriodicFilters() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // Populate years
            for (let i = currentYear + 1; i >= currentYear - 5; i--) {
                const option = new Option(i, i);
                yearFilter.add(option);
            }
            yearFilter.value = currentYear;

            // Populate months
            for (let i = 1; i <= 12; i++) {
                const option = new Option(i, i);
                monthFilter.add(option);
            }
            monthFilter.value = currentMonth;
        }

        function initializeAnnualFilters() {
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 5; i--) {
                annualYearFilter.innerHTML += `<option value="${i}">${i}</option>`;
            }
        }

        async function initializePage() {
            initializePeriodicFilters();
            initializeAnnualFilters(); // <-- Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§
            try {
                // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© getCollectorsFromService Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ’¡ğŸ’¡ğŸ’¡
                allCollectors = await getCollectorsFromService(); 
                allCollectors.forEach(c => {
                    const option = document.createElement('option');
                    option.value = `${c.name} (${c.collectorCode})`;
                    option.dataset.id = c._id;
                    collectorsDatalist.appendChild(option);
                });
            } catch (error) {
                showToast(error.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­ØµÙ„ÙŠÙ†', 'error');
            }
        }
        
        // --- ADDED: Logic to sync cycle filters ---
        function syncCycleFilters() {
            const fromValue = parseInt(fromCycleFilter.value);
            const toValue = parseInt(toCycleFilter.value);

            // Update "To" options
            for (const option of toCycleFilter.options) {
                option.disabled = parseInt(option.value) < fromValue;
            }
            // Auto-correct "To" value if it's now invalid
            if (toValue < fromValue) {
                toCycleFilter.value = fromValue;
            }
        }

        function updateVisibleFilters() {
            const selectedReport = reportTypeSelect.value;
            document.querySelectorAll('.filter-group').forEach(group => group.classList.remove('active'));
            generateReportBtn.disabled = true;
            reportTableContainer.innerHTML = '<p>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</p>';
            currentReportData = [];
            exportExcelBtn.disabled = true;

            if (!selectedReport) return;

            switch (selectedReport) {
                case 'detailed-periodic':
                    document.getElementById('date-range-filter-group').classList.add('active');
                    document.getElementById('collectors-filter-group').classList.add('active');
                    break;
                // --- ADDED: Case for the new report ---
                case 'periodic-summary-table':
                    document.getElementById('periodic-summary-filter-group').classList.add('active');
                    syncCycleFilters(); // Sync filters on selection
                    break;
                case 'annual-summary':
                    document.getElementById('annual-summary-filter-group').classList.add('active');
                    break;
            }
            generateReportBtn.disabled = false;
        }

        async function handleGenerateReport() {
            const reportType = reportTypeSelect.value;
            if (!reportType) return;

            let filters = {};
            let serviceFunction; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³Ù†Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§

            // ØªØ­Ø¯ÙŠØ«: Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            switch (reportType) {
                case 'detailed-periodic':
                    filters.startDate = document.getElementById('startDate').value;
                    filters.endDate = document.getElementById('endDate').value;
                    if (!filters.startDate || !filters.endDate) return showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®', 'warning');
                    const selectedValue = collectorSearchInput.value;
                    const selectedCollector = allCollectors.find(c => `${c.name} (${c.collectorCode})` === selectedValue);
                    filters.collectorId = selectedCollector ? selectedCollector._id : null;
                    serviceFunction = () => reportService.generateReport(reportType, filters); // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                    break;
                
                case 'periodic-summary-table':
                    filters.year = parseInt(yearFilter.value);
                    filters.month = parseInt(monthFilter.value);
                    filters.fromCycle = parseInt(fromCycleFilter.value);
                    filters.toCycle = parseInt(toCycleFilter.value);
                    if (filters.fromCycle > filters.toCycle) {
                    [filters.fromCycle, filters.toCycle] = [filters.toCycle, filters.fromCycle];
                    fromCycleFilter.value = filters.fromCycle;
                    toCycleFilter.value = filters.toCycle;
                    }
                    serviceFunction = () => reportService.generateReport(reportType, filters); // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                    break;

                // --- Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§ ---
                case 'annual-summary':
                    filters.year = annualYearFilter.value;
                    filters.collectorId = annualCollectorIdFilter.value || null;
                    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù†Ø§Ù‡Ø§ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø®Ø¯Ù…Ø©
                    serviceFunction = () => reportService.generateAnnualReport(filters); 
                    break;
            }
            
            reportTableContainer.innerHTML = `<div class="loader"></div>`;
            exportExcelBtn.disabled = true;
            generateReportBtn.disabled = true;

            try {
                currentReportData = await serviceFunction(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                renderReport(reportType); // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
                exportExcelBtn.disabled = !currentReportData || (Array.isArray(currentReportData) && currentReportData.length === 0) || (currentReportData.rows && currentReportData.rows.length === 0);
            } catch (error) {
                reportTableContainer.innerHTML = `<p class="error-message">${error.message}</p>`;
                currentReportData = null;
            } finally {
                generateReportBtn.disabled = false;
            }
        }

        function renderAnnualReport(data) {
            if (!data || !data.rows || data.rows.length === 0) { // ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ .length === 0
                reportTableContainer.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'data-table';

            const theadHTML = `
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø´Ù‡Ø±</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯</th>
                        <th>ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª</th>
                        <th>Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©</th>
                    </tr>
                </thead>`;
            
            let tbodyHTML = '<tbody>';
            data.rows.forEach(row => {
                tbodyHTML += `
                    <tr>
                        <td>${row.month}</td>
                        <td>${formatNumber(row.totalCollection)}</td>
                        <td>${formatNumber(row.totalDeposit)}</td>
                        <td>${formatNumber(row.netAmount)}</td>
                        <td>${(row.receiptCount || 0).toLocaleString('en-US')}</td>
                        <td>${(row.missingCount || 0).toLocaleString('en-US')}</td>
                    </tr>`;
            });
            tbodyHTML += '</tbody>';

            const t = data.totals;
            const tfootHTML = `
                <tfoot>
                    <tr style="font-weight: bold;">
                        <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ</td>
                        <td>${formatNumber(t.totalCollection)}</td>
                        <td>${formatNumber(t.totalDeposit)}</td>
                        <td>${formatNumber(t.netAmount)}</td>
                        <td>${(t.receiptCount || 0).toLocaleString('en-US')}</td>
                        <td>${(t.missingCount || 0).toLocaleString('en-US')}</td>
                    </tr>
                </tfoot>`;

            table.innerHTML = theadHTML + tbodyHTML + tfootHTML;
            reportTableContainer.innerHTML = '';
            reportTableContainer.appendChild(table);
        }
        
        // --- UPDATED: Major update to render both report types ---
        function renderReport(reportType) {
            reportTableContainer.innerHTML = '';
            // ğŸ’¡ğŸ’¡ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø´Ø±Ø· ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ’¡ğŸ’¡ğŸ’¡
            if (!currentReportData || (Array.isArray(currentReportData) && currentReportData.length === 0) || (currentReportData.rows && currentReportData.rows.length === 0)) {
                reportTableContainer.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>';
                return;
            }
            
            switch (reportType) {
                case 'detailed-periodic':
                    renderDetailedPeriodicReport();
                    break;
                case 'periodic-summary-table':
                    renderPeriodicSummaryReport();
                    break;

                case 'annual-summary':
                    renderAnnualReport(currentReportData);
                    break;
            }
        }

        function renderDetailedPeriodicReport() {
            const table = document.createElement('table');
            table.className = 'data-table'; // Ensures consistent styling
            // ØªÙ… Ø­Ø°Ù '<th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯</th>'
            const theadHTML = `<tr><th>Ø§Ù„Ù…Ø­ØµÙ„</th> <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th> <th>Ù…Ù† Ø³Ù†Ø¯</th> <th>Ø¥Ù„Ù‰ Ø³Ù†Ø¯</th> <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª</th> <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</th> <th>Ø§Ù„ØªÙˆØ±ÙŠØ¯</th> <th>Ø§Ù„ØµØ§ÙÙŠ</th> <th>Ø±Ù‚Ù… Ø³Ù†Ø¯ Ø§Ù„ØªÙˆØ±ÙŠØ¯</th> <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>`;
            let tbodyHTML = '';
            let totals = { count: 0, collected: 0, deposited: 0, net: 0 };
            currentReportData.forEach(row => {
                // ØªÙ… Ø­Ø°Ù '<td>${row.depositDate}</td>'
                tbodyHTML += `<tr ${row.isMissing ? 'style="background-color: #fff5f5;"' : ''}><td>${row.collectorName}</td><td>${row.date}</td><td>${row.fromReceipt}</td><td>${row.toReceipt}</td><td>${row.receiptCount}</td><td>${formatNumber(row.totalAmount)}</td><td>${formatNumber(row.depositAmount)}</td><td>${formatNumber(row.netAmount)}</td><td>${row.depositReceipt}</td><td>${row.notes}</td></tr>`;
                if (!row.isMissing) {
                    totals.count += row.receiptCount;
                    totals.collected += row.totalAmount;
                    totals.deposited += row.depositAmount || 0;
                    totals.net += row.netAmount || 0;
                }
            });
            // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ colspan Ù…Ù† "3" Ø¥Ù„Ù‰ "2" Ø­ÙŠØ« ØªÙ… Ø­Ø°Ù Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯
            const tfootHTML = `<tr><th colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>${formatNumber(totals.count)}</th><th>${formatNumber(totals.collected)}</th><th>${formatNumber(totals.deposited)}</th><th>${formatNumber(totals.net)}</th><th colspan="2"></th></tr>`;
            table.innerHTML = `<thead>${theadHTML}</thead><tbody>${tbodyHTML}</tbody><tfoot>${tfootHTML}</tfoot>`;
            reportTableContainer.appendChild(table);
        }
        
        // --- ADDED: Function to render the new multi-table report ---
        function renderPeriodicSummaryReport() {
            const grandTotal = {
                openingBalance: currentReportData[0]?.subTotal.openingBalance || 0,
                assignmentCount: 0, totalCollection: 0, totalDeposit: 0, netAmount: 0
            };

            currentReportData.forEach(cycle => {
                // Update grand totals
                grandTotal.assignmentCount += cycle.subTotal.assignmentCount;
                grandTotal.totalCollection += cycle.subTotal.totalCollection;
                grandTotal.totalDeposit += cycle.subTotal.totalDeposit;

                // Create cycle title
                const title = document.createElement('h3');
                title.className = 'report-cycle-title';
                title.textContent = cycle.title;
                reportTableContainer.appendChild(title);

                // Create cycle table
                const table = document.createElement('table');
                table.className = 'data-table'; // Ensures consistent styling
                const theadHTML = `<tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙ‘Ù„</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯</th><th>ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>`;
                let tbodyHTML = '';
                cycle.rows.forEach(row => {
                    tbodyHTML += `<tr><td>${row.collectorName}</td><td>${formatNumber(row.openingBalance)}</td><td>${formatNumber(row.assignmentCount)}</td><td>${formatNumber(row.totalCollection)}</td><td>${formatNumber(row.totalDeposit)}</td><td>${formatNumber(row.netAmount)}</td><td>${row.notes}</td></tr>`;
                });
                const tfootHTML = `<tr><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©</th><th>${formatNumber(cycle.subTotal.openingBalance)}</th><th>${formatNumber(cycle.subTotal.assignmentCount)}</th><th>${formatNumber(cycle.subTotal.totalCollection)}</th><th>${formatNumber(cycle.subTotal.totalDeposit)}</th><th>${formatNumber(cycle.subTotal.netAmount)}</th><th></th></tr>`;
                table.innerHTML = `<thead>${theadHTML}</thead><tbody>${tbodyHTML}</tbody><tfoot>${tfootHTML}</tfoot>`;
                reportTableContainer.appendChild(table);
            });

            // Calculate final grand total net amount based on the correct formula
            grandTotal.netAmount = grandTotal.openingBalance + grandTotal.totalCollection - grandTotal.totalDeposit;
            
            // Create and append Grand Total table
            const grandTotalTable = document.createElement('table');
            grandTotalTable.className = 'grand-total-table';
            grandTotalTable.innerHTML = `
                <thead><tr><th colspan="6">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</th></tr></thead>
                <tbody><tr>
                    <td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ: <strong>${formatNumber(grandTotal.openingBalance)}</strong></td>
                    <td>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯: <strong>${formatNumber(grandTotal.assignmentCount)}</strong></td>
                    <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„: <strong>${formatNumber(grandTotal.totalCollection)}</strong></td>
                    <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯: <strong>${formatNumber(grandTotal.totalDeposit)}</strong></td>
                    <td colspan="2">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: <strong>${formatNumber(grandTotal.netAmount)}</strong></td>
                </tr></tbody>
            `;
            reportTableContainer.appendChild(grandTotalTable);
        }

        // --- UPDATED: Handle export for both report types ---
        async function handleExport() {
            if (!currentReportData || (Array.isArray(currentReportData) && currentReportData.length === 0) || (currentReportData.rows && currentReportData.rows.length === 0)) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.', 'warning');
                return;
            }
            
            const reportType = reportTypeSelect.value;
            let dataToExport = [];
            let fileName = `${reportType}_${new Date().toISOString().split('T')[0]}.xlsx`;

            exportExcelBtn.disabled = true;
            exportExcelBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                switch (reportType) {
                    case 'detailed-periodic':
                        dataToExport = currentReportData.map(row => ({
                            'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­ØµÙ„': row.collectorName, 'Ø§Ù„ØªØ§Ø±ÙŠØ®': row.date, 'Ù…Ù† Ø³Ù†Ø¯': row.fromReceipt, 'Ø¥Ù„Ù‰ Ø³Ù†Ø¯': row.toReceipt, 
                            'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª': row.receiptCount, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„': row.totalAmount, 'Ø§Ù„ØªÙˆØ±ÙŠØ¯': row.depositAmount, 
                            'Ø§Ù„ØµØ§ÙÙŠ': row.netAmount, 'Ø±Ù‚Ù… Ø³Ù†Ø¯ Ø§Ù„ØªÙˆØ±ÙŠØ¯': row.depositReceipt, /* ØªÙ… Ø­Ø°Ù 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯': row.depositDate, */ 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': row.notes
                        }));
                        const totals = currentReportData.reduce((acc, row) => {
                            if (!row.isMissing) {
                                acc.count += row.receiptCount; acc.collected += row.totalAmount;
                                acc.deposited += row.depositAmount || 0; acc.net += row.netAmount || 0;
                            }
                            return acc;
                        }, { count: 0, collected: 0, deposited: 0, net: 0 });
                        dataToExport.push({});
                        // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„ÙŠØ­Ø°Ù ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù…Ù† ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„
                        dataToExport.push({ 'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ­ØµÙ„': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª': totals.count, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„': totals.collected, 'Ø§Ù„ØªÙˆØ±ÙŠØ¯': totals.deposited, 'Ø§Ù„ØµØ§ÙÙŠ': totals.net, 'Ø±Ù‚Ù… Ø³Ù†Ø¯ Ø§Ù„ØªÙˆØ±ÙŠØ¯': '', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': '' });
                        break;
                    case 'periodic-summary-table':
                        currentReportData.forEach((cycle, index) => {
                            if (index > 0) dataToExport.push({});
                            dataToExport.push({ 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±': cycle.title });
                            const cycleData = cycle.rows.map(row => ({
                                'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙ‘Ù„': row.collectorName, 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': row.openingBalance, 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯': row.assignmentCount,
                                'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„': row.totalCollection, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯': row.totalDeposit, 'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº': row.netAmount, 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': row.notes
                            }));
                            dataToExport.push(...cycleData);
                            dataToExport.push({ 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙ‘Ù„': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': cycle.subTotal.openingBalance, 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯': cycle.subTotal.assignmentCount, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„': cycle.subTotal.totalCollection, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯': cycle.subTotal.totalDeposit, 'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº': cycle.subTotal.netAmount });
                        });

                        // --- Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ø°ÙŠ ØªÙ… Ø­Ø°ÙÙ‡ ---
                        if (currentReportData.length > 0) {
                            const grandTotal = currentReportData.reduce((acc, cycle) => {
                                acc.assignmentCount += cycle.subTotal.assignmentCount;
                                acc.totalCollection += cycle.subTotal.totalCollection;
                                acc.totalDeposit += cycle.subTotal.totalDeposit;
                                return acc;
                            }, {
                                openingBalance: currentReportData[0].subTotal.openingBalance,
                                assignmentCount: 0, totalCollection: 0, totalDeposit: 0
                            });
                            grandTotal.netAmount = grandTotal.openingBalance + grandTotal.totalCollection - grandTotal.totalDeposit;
                            
                            dataToExport.push({});
                            dataToExport.push({ 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª' });
                            dataToExport.push({ 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙ‘Ù„': 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': grandTotal.openingBalance });
                            dataToExport.push({ 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙ‘Ù„': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': grandTotal.assignmentCount });
                            dataToExport.push({ 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙ‘Ù„': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': grandTotal.totalCollection });
                            dataToExport.push({ 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙ‘Ù„': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': grandTotal.totalDeposit });
                            dataToExport.push({ 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­ØµÙ‘Ù„': 'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': grandTotal.netAmount });
                        }
                        break;

                    case 'annual-summary':
                        dataToExport = currentReportData.rows.map(row => ({
                            'Ø§Ù„Ø´Ù‡Ø±': row.month, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„': row.totalCollection, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯': row.totalDeposit,
                            'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº': row.netAmount, 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª': row.receiptCount, 'Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©': row.missingCount
                        }));
                        const t = currentReportData.totals;
                        dataToExport.push({});
                        dataToExport.push({
                            'Ø§Ù„Ø´Ù‡Ø±': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„': t.totalCollection, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯': t.totalDeposit,
                            'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº': t.netAmount, 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª': t.receiptCount, 'Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©': t.missingCount
                        });
                        break;
                }

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Report");
                XLSX.writeFile(wb, fileName);
                showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');

            } catch (error) {
                console.error("Export Error:", error);
                showToast('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù.', 'error');
            } finally {
                exportExcelBtn.disabled = false;
                exportExcelBtn.innerHTML = '<i class="fas fa-file-excel"></i>';
            }
        }

        function setupEventListeners() {
            reportTypeSelect.addEventListener('change', updateVisibleFilters);
            generateReportBtn.addEventListener('click', handleGenerateReport);
            exportExcelBtn.addEventListener('click', handleExport);
            fromCycleFilter.addEventListener('change', syncCycleFilters);

            // --- ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø­ØµÙ„ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ ---
            annualCollectorFilterInput.addEventListener('keyup', () => {
                const term = annualCollectorFilterInput.value.toLowerCase();
                if (!term) {
                    annualCollectorResultsDiv.style.display = 'none'; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… annualCollectorResultsDiv ğŸ’¡ğŸ’¡ğŸ’¡
                    annualCollectorIdFilter.value = '';
                    return;
                }
                const results = allCollectors.filter(c => 
                    c.name.toLowerCase().includes(term) || c.collectorCode.toLowerCase().includes(term)
                );
                
                annualCollectorResultsDiv.innerHTML = ''; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… annualCollectorResultsDiv ğŸ’¡ğŸ’¡ğŸ’¡
                results.slice(0, 7).forEach(c => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = `${c.name} (${c.collectorCode})`;
                    item.dataset.id = c._id;
                    annualCollectorResultsDiv.appendChild(item); // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… annualCollectorResultsDiv ğŸ’¡ğŸ’¡ğŸ’¡
                });
                annualCollectorResultsDiv.style.display = 'block'; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… annualCollectorResultsDiv ğŸ’¡ğŸ’¡ğŸ’¡
            });

            annualCollectorResultsDiv.addEventListener('click', (e) => { // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… annualCollectorResultsDiv ğŸ’¡ğŸ’¡ğŸ’¡
                const item = e.target.closest('.autocomplete-item');
                if(item) {
                    annualCollectorFilterInput.value = item.textContent;
                    annualCollectorIdFilter.value = item.dataset.id;
                    annualCollectorResultsDiv.style.display = 'none'; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… annualCollectorResultsDiv ğŸ’¡ğŸ’¡ğŸ’¡
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-container')) {
                    annualCollectorResultsDiv.style.display = 'none'; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… annualCollectorResultsDiv ğŸ’¡ğŸ’¡ğŸ’¡
                }
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            initializePage();
            setupEventListeners(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        });

    </script>
</body>
</html>