<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مركز التقارير - نظام إدارة الفواتير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .report-controls-top {
            background-color: #fff; padding: 20px; border-radius: 10px;
            margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        .filters-layout {
            display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;
        }
        .filter-group { display: none; }
        .filter-group.active { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        #collectorSearchInput { width: 250px; }
        
        /* --- ADDED: Styles for the new report --- */
        .report-cycle-title {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 25px;
            margin-bottom: 10px;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        .grand-total-table {
            margin-top: 30px;
            width: 100%;
            border-collapse: collapse;
        }
        .grand-total-table th, .grand-total-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
        }
        .grand-total-table th {
            background-color: #343a40;
            color: white;
            font-size: 1.1rem;
        }
        .grand-total-table td {
            font-weight: bold;
            font-size: 1.1rem;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <div class="container">
                <h1>مركز التقارير</h1>
                <nav class="breadcrumb">
                    <a href="dashboard.html">لوحة التحكم</a> / <span>التقارير</span>
                </nav>
            </div>
        </header>

        <main class="page-content">
            <div class="container">
                <div class="report-controls-top">
                    <div class="filters-layout">
                        <div class="form-group">
                            <label for="reportTypeSelect"><strong>اختر نوع التقرير:</strong></label>
                            <select id="reportTypeSelect" class="form-control">
                                <option value="">-- اختر --</option>
                                <option value="detailed-periodic">التقرير التفصيلي الدوري</option>
                                <option value="periodic-summary-table">الجدول التجميعي الدوري</option>
                            </select>
                        </div>

                        <div id="date-range-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="startDate">من تاريخ:</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="endDate">إلى تاريخ:</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                        </div>
                        <div id="collectors-filter-group" class="filter-group">
                             <div class="form-group">
                                 <label for="collectorSearchInput">المحصل:</label>
                                 <input type="text" id="collectorSearchInput" class="form-control" list="collectors-list" placeholder="ابحث بالاسم أو الكود...">
                                 <datalist id="collectors-list"></datalist>
                             </div>
                        </div>
                        
                        <div id="periodic-summary-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="yearFilter">السنة:</label>
                                <select id="yearFilter" class="form-control"></select>
                            </div>
                             <div class="form-group">
                                <label for="monthFilter">الشهر:</label>
                                <select id="monthFilter" class="form-control"></select>
                            </div>
                             <div class="form-group">
                                <label for="fromCycleFilter">من دورة:</label>
                                <select id="fromCycleFilter" class="form-control">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                             <div class="form-group">
                                <label for="toCycleFilter">إلى دورة:</label>
                                <select id="toCycleFilter" class="form-control">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="generateReportBtn" class="btn btn-primary" disabled><i class="fas fa-play-circle"></i> عرض التقرير</button>
                        <button id="exportExcelBtn" class="btn btn-success" disabled><i class="fas fa-file-excel"></i> تصدير Excel</button>
                    </div>
                </div>

                <section class="report-display">
                    <div class="table-container" id="reportTableContainer">
                        <p>النتائج ستظهر هنا...</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="toast" class="toast-notification"><p id="toastMessage"></p></div>

    <script type="module">
        import * as reportService from './assets/js/reports-service.js';
        import { showToast } from './assets/js/utils.js';
        
        let currentReportData = [];
        let allCollectors = [];

        // --- DOM Element References ---
        const reportTypeSelect = document.getElementById('reportTypeSelect');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const reportTableContainer = document.getElementById('reportTableContainer');
        const collectorSearchInput = document.getElementById('collectorSearchInput');
        const collectorsDatalist = document.getElementById('collectors-list');
        // --- ADDED: New filter element references ---
        const yearFilter = document.getElementById('yearFilter');
        const monthFilter = document.getElementById('monthFilter');
        const fromCycleFilter = document.getElementById('fromCycleFilter');
        const toCycleFilter = document.getElementById('toCycleFilter');
        
        // --- Helper function for formatting numbers consistently ---
        function formatNumber(value) {
            return (value ?? 0).toLocaleString('en-US'); // Using en-US for English numerals as requested
        }
        
        // --- ADDED: Function to setup new filters ---
        function initializePeriodicFilters() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // Populate years
            for (let i = currentYear + 1; i >= currentYear - 5; i--) {
                const option = new Option(i, i);
                yearFilter.add(option);
            }
            yearFilter.value = currentYear;

            // Populate months
            for (let i = 1; i <= 12; i++) {
                const option = new Option(i, i);
                monthFilter.add(option);
            }
            monthFilter.value = currentMonth;
        }

        async function initializePage() {
            initializePeriodicFilters(); // Setup new filters
            try {
                const response = await fetch('http://localhost:3000/api/collectors');
                if (!response.ok) throw new Error('فشل الاتصال بخادم المحصلين');
                allCollectors = await response.json();
                allCollectors.forEach(c => {
                    const option = document.createElement('option');
                    option.value = `${c.name} (${c.collectorCode})`;
                    option.dataset.id = c._id;
                    collectorsDatalist.appendChild(option);
                });
            } catch (error) {
                showToast(error.message || 'فشل تحميل قائمة المحصلين', 'error');
            }
        }
        
        // --- ADDED: Logic to sync cycle filters ---
        function syncCycleFilters() {
            const fromValue = parseInt(fromCycleFilter.value);
            const toValue = parseInt(toCycleFilter.value);

            // Update "To" options
            for (const option of toCycleFilter.options) {
                option.disabled = parseInt(option.value) < fromValue;
            }
            // Auto-correct "To" value if it's now invalid
            if (toValue < fromValue) {
                toCycleFilter.value = fromValue;
            }
        }

        function updateVisibleFilters() {
            const selectedReport = reportTypeSelect.value;
            document.querySelectorAll('.filter-group').forEach(group => group.classList.remove('active'));
            generateReportBtn.disabled = true;
            reportTableContainer.innerHTML = '<p>النتائج ستظهر هنا...</p>';
            currentReportData = [];
            exportExcelBtn.disabled = true;

            if (!selectedReport) return;

            switch (selectedReport) {
                case 'detailed-periodic':
                    document.getElementById('date-range-filter-group').classList.add('active');
                    document.getElementById('collectors-filter-group').classList.add('active');
                    break;
                // --- ADDED: Case for the new report ---
                case 'periodic-summary-table':
                    document.getElementById('periodic-summary-filter-group').classList.add('active');
                    syncCycleFilters(); // Sync filters on selection
                    break;
            }
            generateReportBtn.disabled = false;
        }

        async function handleGenerateReport() {
            const reportType = reportTypeSelect.value;
            if (!reportType) return;

            let filters = {};
            // --- UPDATED: Logic to gather filters based on report type ---
            switch (reportType) {
                case 'detailed-periodic':
                    filters.startDate = document.getElementById('startDate').value;
                    filters.endDate = document.getElementById('endDate').value;
                    if (!filters.startDate || !filters.endDate) return showToast('الرجاء تحديد نطاق التاريخ', 'warning');
                    const selectedValue = collectorSearchInput.value;
                    const selectedCollector = allCollectors.find(c => `${c.name} (${c.collectorCode})` === selectedValue);
                    filters.collectorId = selectedCollector ? selectedCollector._id : null;
                    break;
                
                case 'periodic-summary-table':
                    filters.year = parseInt(yearFilter.value);
                    filters.month = parseInt(monthFilter.value);
                    filters.fromCycle = parseInt(fromCycleFilter.value);
                    filters.toCycle = parseInt(toCycleFilter.value);
                    // Auto-correct if from > to
                    if (filters.fromCycle > filters.toCycle) {
                       [filters.fromCycle, filters.toCycle] = [filters.toCycle, filters.fromCycle];
                       fromCycleFilter.value = filters.fromCycle;
                       toCycleFilter.value = filters.toCycle;
                    }
                    break;
            }
            
            reportTableContainer.innerHTML = `<div class="loader"></div>`;
            exportExcelBtn.disabled = true;
            generateReportBtn.disabled = true;

            try {
                currentReportData = await reportService.generateReport(reportType, filters);
                renderReport(reportType);
                exportExcelBtn.disabled = currentReportData.length === 0;
            } catch (error) {
                reportTableContainer.innerHTML = `<p class="error-message">${error.message}</p>`;
                currentReportData = [];
            } finally {
                generateReportBtn.disabled = false;
            }
        }
        
        // --- UPDATED: Major update to render both report types ---
        function renderReport(reportType) {
            reportTableContainer.innerHTML = '';
            if (currentReportData.length === 0) {
                reportTableContainer.innerHTML = '<p>لا توجد بيانات لعرضها بناءً على الفلاتر المحددة.</p>';
                return;
            }
            
            switch (reportType) {
                case 'detailed-periodic':
                    renderDetailedPeriodicReport();
                    break;
                case 'periodic-summary-table':
                    renderPeriodicSummaryReport();
                    break;
            }
        }

        function renderDetailedPeriodicReport() {
            const table = document.createElement('table');
            table.className = 'data-table'; // Ensures consistent styling
            const theadHTML = `<tr><th>المحصل</th> <th>التاريخ</th> <th>من سند</th> <th>إلى سند</th> <th>عدد السندات</th> <th>إجمالي التحصيل</th> <th>التوريد</th> <th>الصافي</th> <th>رقم سند التوريد</th> <th>تاريخ التوريد</th> <th>ملاحظات</th></tr>`;
            let tbodyHTML = '';
            let totals = { count: 0, collected: 0, deposited: 0, net: 0 };
            currentReportData.forEach(row => {
                tbodyHTML += `<tr ${row.isMissing ? 'style="background-color: #fff5f5;"' : ''}><td>${row.collectorName}</td><td>${row.date}</td><td>${row.fromReceipt}</td><td>${row.toReceipt}</td><td>${row.receiptCount}</td><td>${formatNumber(row.totalAmount)}</td><td>${formatNumber(row.depositAmount)}</td><td>${formatNumber(row.netAmount)}</td><td>${row.depositReceipt}</td><td>${row.depositDate}</td><td>${row.notes}</td></tr>`;
                if (!row.isMissing) {
                    totals.count += row.receiptCount;
                    totals.collected += row.totalAmount;
                    totals.deposited += row.depositAmount || 0;
                    totals.net += row.netAmount || 0;
                }
            });
            const tfootHTML = `<tr><th colspan="4">الإجمالي</th><th>${formatNumber(totals.count)}</th><th>${formatNumber(totals.collected)}</th><th>${formatNumber(totals.deposited)}</th><th>${formatNumber(totals.net)}</th><th colspan="3"></th></tr>`;
            table.innerHTML = `<thead>${theadHTML}</thead><tbody>${tbodyHTML}</tbody><tfoot>${tfootHTML}</tfoot>`;
            reportTableContainer.appendChild(table);
        }
        
        // --- ADDED: Function to render the new multi-table report ---
        function renderPeriodicSummaryReport() {
            const grandTotal = {
                openingBalance: currentReportData[0]?.subTotal.openingBalance || 0,
                assignmentCount: 0, totalCollection: 0, totalDeposit: 0, netAmount: 0
            };

            currentReportData.forEach(cycle => {
                // Update grand totals
                grandTotal.assignmentCount += cycle.subTotal.assignmentCount;
                grandTotal.totalCollection += cycle.subTotal.totalCollection;
                grandTotal.totalDeposit += cycle.subTotal.totalDeposit;

                // Create cycle title
                const title = document.createElement('h3');
                title.className = 'report-cycle-title';
                title.textContent = cycle.title;
                reportTableContainer.appendChild(title);

                // Create cycle table
                const table = document.createElement('table');
                table.className = 'data-table'; // Ensures consistent styling
                const theadHTML = `<tr><th>اسم المحصّل</th><th>الرصيد الافتتاحي</th><th>عدد الإسناد</th><th>إجمالي التحصيل</th><th>إجمالي التوريد</th><th>صافي المبلغ</th><th>ملاحظات</th></tr>`;
                let tbodyHTML = '';
                cycle.rows.forEach(row => {
                    tbodyHTML += `<tr><td>${row.collectorName}</td><td>${formatNumber(row.openingBalance)}</td><td>${formatNumber(row.assignmentCount)}</td><td>${formatNumber(row.totalCollection)}</td><td>${formatNumber(row.totalDeposit)}</td><td>${formatNumber(row.netAmount)}</td><td>${row.notes}</td></tr>`;
                });
                const tfootHTML = `<tr><th>إجمالي الدورة</th><th>${formatNumber(cycle.subTotal.openingBalance)}</th><th>${formatNumber(cycle.subTotal.assignmentCount)}</th><th>${formatNumber(cycle.subTotal.totalCollection)}</th><th>${formatNumber(cycle.subTotal.totalDeposit)}</th><th>${formatNumber(cycle.subTotal.netAmount)}</th><th></th></tr>`;
                table.innerHTML = `<thead>${theadHTML}</thead><tbody>${tbodyHTML}</tbody><tfoot>${tfootHTML}</tfoot>`;
                reportTableContainer.appendChild(table);
            });

            // Calculate final grand total net amount based on the correct formula
            grandTotal.netAmount = grandTotal.openingBalance + grandTotal.totalCollection - grandTotal.totalDeposit;
            
            // Create and append Grand Total table
            const grandTotalTable = document.createElement('table');
            grandTotalTable.className = 'grand-total-table';
            grandTotalTable.innerHTML = `
                <thead><tr><th colspan="6">الإجمالي النهائي لكل الدورات</th></tr></thead>
                <tbody><tr>
                    <td>الرصيد الافتتاحي: <strong>${formatNumber(grandTotal.openingBalance)}</strong></td>
                    <td>عدد الإسناد: <strong>${formatNumber(grandTotal.assignmentCount)}</strong></td>
                    <td>إجمالي التحصيل: <strong>${formatNumber(grandTotal.totalCollection)}</strong></td>
                    <td>إجمالي التوريد: <strong>${formatNumber(grandTotal.totalDeposit)}</strong></td>
                    <td colspan="2">صافي المبلغ: <strong>${formatNumber(grandTotal.netAmount)}</strong></td>
                </tr></tbody>
            `;
            reportTableContainer.appendChild(grandTotalTable);
        }

        // --- UPDATED: Handle export for both report types ---
        function handleExport() {
            if (currentReportData.length === 0) return showToast('لا توجد بيانات لتصديرها.', 'warning');
            
            const reportType = reportTypeSelect.value;
            let dataToExport = [];
            let fileName = `${reportType}_Export.xlsx`;

            if (reportType === 'detailed-periodic') {
                dataToExport = currentReportData.map(row => ({'اسم المحصل': row.collectorName, 'التاريخ': row.date, 'من سند': row.fromReceipt, 'إلى سند': row.toReceipt, 'عدد السندات': row.receiptCount, 'إجمالي التحصيل': row.totalAmount, 'التوريد': row.depositAmount, 'الصافي': row.netAmount, 'رقم سند التوريد': row.depositReceipt, 'تاريخ التوريد': row.depositDate, 'ملاحظات': row.notes}));
                
                const totals = { count: 0, collected: 0, deposited: 0, net: 0 };
                currentReportData.forEach(row => {
                    if (!row.isMissing) {
                        totals.count += row.receiptCount;
                        totals.collected += row.totalAmount;
                        totals.deposited += row.depositAmount || 0;
                        totals.net += row.netAmount || 0;
                    }
                });
                if (dataToExport.length > 0) {
                    dataToExport.push({});
                    dataToExport.push({
                        'اسم المحصل': 'الإجمالي', 'التاريخ': '', 'من سند': '', 'إلى سند': '',
                        'عدد السندات': totals.count, 'إجمالي التحصيل': totals.collected,
                        'التوريد': totals.deposited, 'الصافي': totals.net,
                        'رقم سند التوريد': '', 'تاريخ التوريد': '', 'ملاحظات': ''
                    });
                }

            } else if (reportType === 'periodic-summary-table') {
                // --- التعديل يبدأ هنا ---

                // 1. معالجة الدورات وإجمالياتها الفرعية (كما كان)
                currentReportData.forEach((cycle, index) => {
                    if (index > 0) dataToExport.push({}); // صف فارغ للفصل
                    dataToExport.push({ 'التقرير': cycle.title }); // عنوان الدورة
                    
                    const cycleData = cycle.rows.map(row => ({
                        'اسم المحصّل': row.collectorName,
                        'الرصيد الافتتاحي': row.openingBalance,
                        'عدد الإسناد': row.assignmentCount,
                        'إجمالي التحصيل': row.totalCollection,
                        'إجمالي التوريد': row.totalDeposit,
                        'صافي المبلغ': row.netAmount,
                        'ملاحظات': row.notes
                    }));
                    dataToExport.push(...cycleData);
                    
                    // إضافة صف إجمالي الدورة
                    dataToExport.push({
                        'اسم المحصّل': 'إجمالي الدورة',
                        'الرصيد الافتتاحي': cycle.subTotal.openingBalance,
                        'عدد الإسناد': cycle.subTotal.assignmentCount,
                        'إجمالي التحصيل': cycle.subTotal.totalCollection,
                        'إجمالي التوريد': cycle.subTotal.totalDeposit,
                        'صافي المبلغ': cycle.subTotal.netAmount
                    });
                });

                // 2. حساب الإجمالي النهائي (الإضافة الجديدة والمهمة)
                if (currentReportData.length > 0) {
                    const grandTotal = {
                        openingBalance: currentReportData[0].subTotal.openingBalance, // فقط من الدورة الأولى
                        assignmentCount: 0, totalCollection: 0, totalDeposit: 0
                    };
                    currentReportData.forEach(cycle => {
                        grandTotal.assignmentCount += cycle.subTotal.assignmentCount;
                        grandTotal.totalCollection += cycle.subTotal.totalCollection;
                        grandTotal.totalDeposit += cycle.subTotal.totalDeposit;
                    });
                    // حساب الصافي النهائي بناءً على المعادلة الصحيحة
                    grandTotal.netAmount = grandTotal.openingBalance + grandTotal.totalCollection - grandTotal.totalDeposit;

                    // 3. إضافة صف الإجمالي النهائي لبيانات التصدير
                    dataToExport.push({}); // صف فارغ للفصل
                    dataToExport.push({ 'التقرير': 'الإجمالي النهائي لكل الدورات' });
                    dataToExport.push({
                        'اسم المحصّل': 'الرصيد الافتتاحي',
                        'الرصيد الافتتاحي': grandTotal.openingBalance
                    });
                    dataToExport.push({
                        'اسم المحصّل': 'إجمالي عدد الإسناد',
                        'الرصيد الافتتاحي': grandTotal.assignmentCount
                    });
                    dataToExport.push({
                        'اسم المحصّل': 'إجمالي التحصيل',
                        'الرصيد الافتتاحي': grandTotal.totalCollection
                    });
                    dataToExport.push({
                        'اسم المحصّل': 'إجمالي التوريد',
                        'الرصيد الافتتاحي': grandTotal.totalDeposit
                    });
                    dataToExport.push({
                        'اسم المحصّل': 'صافي المبلغ الإجمالي',
                        'الرصيد الافتتاحي': grandTotal.netAmount
                    });
                }
                // --- نهاية التعديل ---
            }

            if (dataToExport.length === 0) return showToast('لا توجد بيانات لتصديرها', 'warning');

            const ws = XLSX.utils.json_to_sheet(dataToExport, {skipHeader: true}); // skipHeader لتنسيق أفضل
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, fileName);
            showToast('تم تصدير التقرير بنجاح', 'success');
        }

        document.addEventListener('DOMContentLoaded', initializePage);
        reportTypeSelect.addEventListener('change', updateVisibleFilters);
        generateReportBtn.addEventListener('click', handleGenerateReport);
        exportExcelBtn.addEventListener('click', handleExport);
        // --- ADDED: Event listener for cycle filters ---
        fromCycleFilter.addEventListener('change', syncCycleFilters);

    </script>
</body>
</html>