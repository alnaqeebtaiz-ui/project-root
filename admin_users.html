<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal-footer .btn-secondary {
            background-color: #6c757d; /* Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© */
            color: white; /* Ù†Øµ Ø£Ø¨ÙŠØ¶ */
            border: 1px solid #6c757d; /* Ø­Ø¯ Ø±Ù…Ø§Ø¯ÙŠ */
            padding: 0.4rem 0.8rem; /* ØªØµØºÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
            font-size: 0.875rem; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
            line-height: 1.5;
            border-radius: 4px; /* Ø²ÙˆØ§ÙŠØ§ Ù…Ø³ØªØ¯ÙŠØ±Ø© */
            transition: background-color 0.3s ease; /* Ø­Ø±ÙƒØ© Ù†Ø§Ø¹Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
        }

        .modal-footer .btn-secondary:hover {
            background-color: #5a6268; /* Ù„ÙˆÙ† Ø£ØºÙ…Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
            border-color: #545b62;
        }

        /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø«Ø§Ù†ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal-footer .btn-primary,
        .modal-footer .btn-secondary {
            font-size: 0.875rem; /* Ø­Ø¬Ù… Ø®Ø· Ù…ÙˆØ­Ø¯ ÙˆØµØºÙŠØ± Ù„ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
            padding: 0.4rem 0.8rem; /* padding Ù…ÙˆØ­Ø¯ */
        }

        /* Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù„Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯" Ø£ÙŠØ¶Ø§Ù‹ */
        #addUserBtn {
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
        }

    </style>
</head>
<body>

    <div class="page-container">
        <header class="page-header">
            <div class="container">
                <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
                <nav class="breadcrumb">
                    <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a> / <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                </nav>
            </div>
        </header>

        <main class="page-content">
            <div class="container">
                <div class="action-bar-container">
                    <div class="action-bar">
                        <button id="addUserBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th> <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th style="text-align: center;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>

                </div>
        </main>
    </div>
    
    <div id="userModal" class="modal">
        <div class="modal-content">
            <header class="modal-header">
                <h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close-btn">&times;</button>
            </header>
            <form id="userForm">
                <div class="modal-body">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¯Ø®ÙˆÙ„):</label>
                        <input type="text" id="username" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label> <input type="email" id="email" required class="form-control"> </div>
                    <div class="form-group">
                        <label for="role">Ø§Ù„Ø¯ÙˆØ±:</label>
                        <select id="role" required class="form-control">
                            <option value="">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ù‹Ø§</option>
                            <option value="collector">Ù…Ø­ØµÙ„</option> <option value="manager">Ù…Ø¯ÙŠØ±</option>    <option value="admin">Ù…Ø³Ø¤ÙˆÙ„</option>    </select>
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                        <input type="password" id="password" required class="form-control">
                    </div>
                    <div class="form-group" id="confirmPasswordGroup">
                        <label for="confirmPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                        <input type="password" id="confirmPassword" required class="form-control">
                    </div>
                </div>
                <footer class="modal-footer">
                    <button type="button" class="btn btn-secondary close-btn">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                </footer>
            </form>
        </div>
    </div>

    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <header class="modal-header">
                <h2>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
                <button class="close-btn">&times;</button>
            </header>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <input type="hidden" id="changePassUserId">
                    <div class="form-group">
                        <label for="newPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                        <input type="password" id="newPassword" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="confirmNewPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                        <input type="password" id="confirmNewPassword" required class="form-control">
                    </div>
                </div>
                <footer class="modal-footer">
                    <button type="button" class="btn btn-secondary close-btn">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                </footer>
            </form>
        </div>
    </div>

    <div id="deleteConfirmationModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <header class="modal-header"><h2>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2></header>
            <div class="modal-body" style="text-align: center;"><p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ</p></div>
            <footer class="modal-footer">
                <button type="button" id="cancelDeleteBtn" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Ù†Ø¹Ù…, Ø­Ø°Ù</button>
            </footer>
        </div>
    </div>
    <div id="toast" class="toast-notification"><p id="toastMessage"></p></div>

    <script type="module">
        import * as userService from './assets/js/users-service.js';
        import { showToast, sanitizeInput } from './assets/js/utils.js';

        let userIdToDelete = null;

        const usersTableBody = document.getElementById('usersTableBody');
        const addUserBtn = document.getElementById('addUserBtn');
        const userModal = document.getElementById('userModal');
        const modalTitle = document.getElementById('modalTitle');
        const userForm = document.getElementById('userForm');
        const userIdInput = document.getElementById('userId');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email'); // ğŸ’¡ğŸ’¡ğŸ’¡ ØªÙ… ØªØºÙŠÙŠØ± fullNameInput Ø¥Ù„Ù‰ emailInput ğŸ’¡ğŸ’¡ğŸ’¡
        const roleInput = document.getElementById('role');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const passwordGroup = document.getElementById('passwordGroup');
        const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');

        const changePasswordModal = document.getElementById('changePasswordModal');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const changePassUserIdInput = document.getElementById('changePassUserId');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

        const deleteModal = document.getElementById('deleteConfirmationModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        async function loadUsers() {
            usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</td></tr>`;
            try {
                console.log("USERS.HTML: Calling getUsers service...");
                const users = await userService.getUsers(); 
                console.log("USERS.HTML: Received data from service:", users);

                if (!Array.isArray(users)) {
                    console.error("USERS.HTML: Expected an array of users, but received:", users);
                    usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Ø®Ø·Ø£: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….</td></tr>`;
                    showToast('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….', 'error');
                    return;
                }
                displayUsers(users);
            } catch (error) {
                console.error("USERS.HTML: Error loading users:", error);
                usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">${error.message || 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.'}</td></tr>`;
                showToast(error.message || 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.', 'error');
            }
        }

        function displayUsers(users) { 
            usersTableBody.innerHTML = '';
            if (users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù„Ø¹Ø±Ø¶Ù‡Ù….</td></tr>';
                return;
            }
            users.forEach(user => {
                const row = document.createElement('tr');
                const userStatus = user.isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„';
                const statusClass = user.isActive ? 'status-success' : 'status-danger';

                row.innerHTML = `
                    <td>${sanitizeInput(user.username)}</td>
                    <td>${sanitizeInput(user.email || '')}</td> <td>${sanitizeInput(user.role)}</td>
                    <td><span class="status ${statusClass}">${userStatus}</span></td>
                    <td class="actions-cell">
                        <button class="btn btn-warning btn-sm" data-id="${user._id}" data-action="edit">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-info btn-sm" data-id="${user._id}" data-action="change-password">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
                        <button class="btn ${user.isActive ? 'btn-secondary' : 'btn-success'} btn-sm" data-id="${user._id}" data-current-status="${user.isActive}" data-action="toggle-status">
                            ${user.isActive ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}
                        </button>
                        <button class="btn btn-danger btn-sm" data-id="${user._id}" data-action="delete">Ø­Ø°Ù</button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });
        }

        function openUserModal(user = null) {
            userForm.reset();
            passwordGroup.style.display = 'block';
            confirmPasswordGroup.style.display = 'block';
            
            if (user) { 
                modalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                userIdInput.value = user._id;
                usernameInput.value = user.username;
                emailInput.value = user.email || ''; // ğŸ’¡ğŸ’¡ğŸ’¡ ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© email ğŸ’¡ğŸ’¡ğŸ’¡
                roleInput.value = user.role;
                passwordInput.removeAttribute('required');
                confirmPasswordInput.removeAttribute('required');
                passwordGroup.style.display = 'none';
                confirmPasswordGroup.style.display = 'none';
            } else { 
                modalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
                userIdInput.value = '';
                passwordInput.setAttribute('required', 'true');
                confirmPasswordInput.setAttribute('required', 'true');
            }
            userModal.classList.add('show');
        }

        function closeUserModal() {
            userModal.classList.remove('show');
            userForm.reset();
        }

        function openChangePasswordModal(id) {
            changePasswordForm.reset();
            changePassUserIdInput.value = id;
            changePasswordModal.classList.add('show');
        }

        function closeChangePasswordModal() {
            changePasswordModal.classList.remove('show');
            changePasswordForm.reset();
        }

        function openDeleteModal(id) {
            userIdToDelete = id;
            deleteModal.classList.add('show');
        }

        function closeDeleteModal() {
            userIdToDelete = null;
            deleteModal.classList.remove('show');
        }

        addUserBtn.addEventListener('click', () => openUserModal());

        userModal.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', closeUserModal);
        });
        changePasswordModal.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', closeChangePasswordModal);
        });
        deleteModal.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', closeDeleteModal);
        });


        userForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const submitBtn = userForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const userId = userIdInput.value;
            const isEditMode = !!userId;

            const username = usernameInput.value;
            const email = emailInput.value; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© email ğŸ’¡ğŸ’¡ğŸ’¡
            const role = roleInput.value;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (!isEditMode && password !== confirmPassword) {
                showToast('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†!', 'error');
                submitBtn.disabled = false;
                return;
            }

            try {
                if (isEditMode) {
                    const updateData = { username, email, role }; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø¥Ø±Ø³Ø§Ù„ email ğŸ’¡ğŸ’¡ğŸ’¡
                    await userService.updateUser(userId, updateData);
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    const newUser = { username, email, role, password }; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø¥Ø±Ø³Ø§Ù„ email ğŸ’¡ğŸ’¡ğŸ’¡
                    await userService.addUser(newUser);
                    showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
                closeUserModal();
                loadUsers();
            } catch (error) {
                showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        changePasswordForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const userId = changePassUserIdInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (newPassword !== confirmNewPassword) {
                showToast('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ØªØ§Ù† ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†!', 'error');
                submitBtn.disabled = false;
                return;
            }

            try {
                await userService.changeUserPassword(userId, newPassword);
                showToast('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
                closeChangePasswordModal();
            } catch (error) {
                showToast(error.message || 'ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        usersTableBody.addEventListener('click', async (event) => {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const id = button.dataset.id;
            const action = button.dataset.action;

            try {
                switch (action) {
                    case 'edit':
                        const userToEdit = await userService.getUserById(id);
                        openUserModal(userToEdit);
                        break;
                    case 'change-password':
                        openChangePasswordModal(id);
                        break;
                    case 'toggle-status':
                        const currentStatus = button.dataset.currentStatus === 'true'; // ğŸ’¡ğŸ’¡ğŸ’¡ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ğŸ’¡ğŸ’¡ğŸ’¡
                        await userService.toggleUserStatus(id, !currentStatus); // ğŸ’¡ğŸ’¡ğŸ’¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ’¡ğŸ’¡ğŸ’¡
                        showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        loadUsers();
                        break;
                    case 'delete':
                        openDeleteModal(id);
                        break;
                }
            } catch (error) {
                showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£.', 'error');
            }
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!userIdToDelete) return;
            try {
                await userService.deleteUser(userIdToDelete);
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                closeDeleteModal();
                loadUsers();
            } catch (error) {
                showToast(error.message || 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'error');
            }
        });

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);

        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });
    </script>
</body>
</html>