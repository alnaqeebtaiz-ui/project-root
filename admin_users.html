<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المستخدمين - برنامج إدارة فواتير الكهرباء</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        /* تنسيق خاص لأزرار الإلغاء في المودال */
        .modal-footer .btn-secondary {
            background-color: #6c757d; /* خلفية رمادية */
            color: white; /* نص أبيض */
            border: 1px solid #6c757d; /* حد رمادي */
            padding: 0.4rem 0.8rem; /* تصغير المساحة الداخلية */
            font-size: 0.875rem; /* تصغير حجم الخط */
            line-height: 1.5;
            border-radius: 4px; /* زوايا مستديرة */
            transition: background-color 0.3s ease; /* حركة ناعمة عند التحويم */
        }

        .modal-footer .btn-secondary:hover {
            background-color: #5a6268; /* لون أغمق عند التحويم */
            border-color: #545b62;
        }

        /* تصغير حجم الخط للأزرار الأساسية والثانوية في المودال */
        .modal-footer .btn-primary,
        .modal-footer .btn-secondary {
            font-size: 0.875rem; /* حجم خط موحد وصغير لكل الأزرار في تذييل المودال */
            padding: 0.4rem 0.8rem; /* padding موحد */
        }

        /* إذا كنت تريد تصغير الخط لزر "إضافة مستخدم جديد" أيضاً */
        #addUserBtn {
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
        }

    </style>
</head>
<body>

    <div class="page-container">
        <header class="page-header">
            <div class="container">
                <h1>إدارة المستخدمين</h1>
                <nav class="breadcrumb">
                    <a href="dashboard.html">لوحة التحكم</a> / <span>إدارة المستخدمين</span>
                </nav>
            </div>
        </header>

        <main class="page-content">
            <div class="container">
                <div class="action-bar-container">
                    <div class="action-bar">
                        <button id="addUserBtn" class="btn btn-primary">إضافة مستخدم جديد</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اسم المستخدم</th>
                                <th>البريد الإلكتروني</th> <th>الدور</th>
                                <th>الحالة</th>
                                <th style="text-align: center;">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>

                </div>
        </main>
    </div>
    
    <div id="userModal" class="modal">
        <div class="modal-content">
            <header class="modal-header">
                <h2 id="modalTitle">إضافة مستخدم جديد</h2>
                <button class="close-btn">&times;</button>
            </header>
            <form id="userForm">
                <div class="modal-body">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label for="username">اسم المستخدم (للدخول):</label>
                        <input type="text" id="username" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="email">البريد الإلكتروني:</label> <input type="email" id="email" required class="form-control"> </div>
                    <div class="form-group">
                        <label for="role">الدور:</label>
                        <select id="role" required class="form-control">
                            <option value="">اختر دورًا</option>
                            <option value="collector">محصل</option> <option value="manager">مدير</option>    <option value="admin">مسؤول</option>    </select>
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label for="password">كلمة المرور:</label>
                        <input type="password" id="password" required class="form-control">
                    </div>
                    <div class="form-group" id="confirmPasswordGroup">
                        <label for="confirmPassword">تأكيد كلمة المرور:</label>
                        <input type="password" id="confirmPassword" required class="form-control">
                    </div>
                </div>
                <footer class="modal-footer">
                    <button type="button" class="btn btn-secondary close-btn">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </footer>
            </form>
        </div>
    </div>

    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <header class="modal-header">
                <h2>تغيير كلمة المرور</h2>
                <button class="close-btn">&times;</button>
            </header>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <input type="hidden" id="changePassUserId">
                    <div class="form-group">
                        <label for="newPassword">كلمة المرور الجديدة:</label>
                        <input type="password" id="newPassword" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="confirmNewPassword">تأكيد كلمة المرور الجديدة:</label>
                        <input type="password" id="confirmNewPassword" required class="form-control">
                    </div>
                </div>
                <footer class="modal-footer">
                    <button type="button" class="btn btn-secondary close-btn">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </footer>
            </form>
        </div>
    </div>

    <div id="deleteConfirmationModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <header class="modal-header"><h2>تأكيد الحذف</h2></header>
            <div class="modal-body" style="text-align: center;"><p>هل أنت متأكد من حذف هذا المستخدم؟</p></div>
            <footer class="modal-footer">
                <button type="button" id="cancelDeleteBtn" class="btn btn-secondary">إلغاء</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">نعم, حذف</button>
            </footer>
        </div>
    </div>
    <div id="toast" class="toast-notification"><p id="toastMessage"></p></div>

    <script type="module">
        import * as userService from './assets/js/users-service.js';
        import { showToast, sanitizeInput } from './assets/js/utils.js';

        let userIdToDelete = null;

        const usersTableBody = document.getElementById('usersTableBody');
        const addUserBtn = document.getElementById('addUserBtn');
        const userModal = document.getElementById('userModal');
        const modalTitle = document.getElementById('modalTitle');
        const userForm = document.getElementById('userForm');
        const userIdInput = document.getElementById('userId');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email'); // 💡💡💡 تم تغيير fullNameInput إلى emailInput 💡💡💡
        const roleInput = document.getElementById('role');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const passwordGroup = document.getElementById('passwordGroup');
        const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');

        const changePasswordModal = document.getElementById('changePasswordModal');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const changePassUserIdInput = document.getElementById('changePassUserId');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

        const deleteModal = document.getElementById('deleteConfirmationModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        async function loadUsers() {
            usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem;">جاري تحميل المستخدمين...</td></tr>`;
            try {
                console.log("USERS.HTML: Calling getUsers service...");
                const users = await userService.getUsers(); 
                console.log("USERS.HTML: Received data from service:", users);

                if (!Array.isArray(users)) {
                    console.error("USERS.HTML: Expected an array of users, but received:", users);
                    usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">خطأ: تنسيق البيانات غير متوقع من الخادم.</td></tr>`;
                    showToast('خطأ في تنسيق بيانات المستخدمين من الخادم.', 'error');
                    return;
                }
                displayUsers(users);
            } catch (error) {
                console.error("USERS.HTML: Error loading users:", error);
                usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">${error.message || 'فشل في جلب المستخدمين.'}</td></tr>`;
                showToast(error.message || 'فشل في جلب المستخدمين.', 'error');
            }
        }

        function displayUsers(users) { 
            usersTableBody.innerHTML = '';
            if (users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">لا يوجد مستخدمون لعرضهم.</td></tr>';
                return;
            }
            users.forEach(user => {
                const row = document.createElement('tr');
                const userStatus = user.isActive ? 'نشط' : 'معطل';
                const statusClass = user.isActive ? 'status-success' : 'status-danger';

                row.innerHTML = `
                    <td>${sanitizeInput(user.username)}</td>
                    <td>${sanitizeInput(user.email || '')}</td> <td>${sanitizeInput(user.role)}</td>
                    <td><span class="status ${statusClass}">${userStatus}</span></td>
                    <td class="actions-cell">
                        <button class="btn btn-warning btn-sm" data-id="${user._id}" data-action="edit">تعديل</button>
                        <button class="btn btn-info btn-sm" data-id="${user._id}" data-action="change-password">تغيير كلمة المرور</button>
                        <button class="btn ${user.isActive ? 'btn-secondary' : 'btn-success'} btn-sm" data-id="${user._id}" data-current-status="${user.isActive}" data-action="toggle-status">
                            ${user.isActive ? 'تعطيل' : 'تفعيل'}
                        </button>
                        <button class="btn btn-danger btn-sm" data-id="${user._id}" data-action="delete">حذف</button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });
        }

        function openUserModal(user = null) {
            userForm.reset();
            passwordGroup.style.display = 'block';
            confirmPasswordGroup.style.display = 'block';
            
            if (user) { 
                modalTitle.textContent = 'تعديل بيانات المستخدم';
                userIdInput.value = user._id;
                usernameInput.value = user.username;
                emailInput.value = user.email || ''; // 💡💡💡 تعيين قيمة email 💡💡💡
                roleInput.value = user.role;
                passwordInput.removeAttribute('required');
                confirmPasswordInput.removeAttribute('required');
                passwordGroup.style.display = 'none';
                confirmPasswordGroup.style.display = 'none';
            } else { 
                modalTitle.textContent = 'إضافة مستخدم جديد';
                userIdInput.value = '';
                passwordInput.setAttribute('required', 'true');
                confirmPasswordInput.setAttribute('required', 'true');
            }
            userModal.classList.add('show');
        }

        function closeUserModal() {
            userModal.classList.remove('show');
            userForm.reset();
        }

        function openChangePasswordModal(id) {
            changePasswordForm.reset();
            changePassUserIdInput.value = id;
            changePasswordModal.classList.add('show');
        }

        function closeChangePasswordModal() {
            changePasswordModal.classList.remove('show');
            changePasswordForm.reset();
        }

        function openDeleteModal(id) {
            userIdToDelete = id;
            deleteModal.classList.add('show');
        }

        function closeDeleteModal() {
            userIdToDelete = null;
            deleteModal.classList.remove('show');
        }

        addUserBtn.addEventListener('click', () => openUserModal());

        userModal.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', closeUserModal);
        });
        changePasswordModal.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', closeChangePasswordModal);
        });
        deleteModal.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', closeDeleteModal);
        });


        userForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const submitBtn = userForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const userId = userIdInput.value;
            const isEditMode = !!userId;

            const username = usernameInput.value;
            const email = emailInput.value; // 💡💡💡 الحصول على قيمة email 💡💡💡
            const role = roleInput.value;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (!isEditMode && password !== confirmPassword) {
                showToast('كلمتا المرور غير متطابقتين!', 'error');
                submitBtn.disabled = false;
                return;
            }

            try {
                if (isEditMode) {
                    const updateData = { username, email, role }; // 💡💡💡 إرسال email 💡💡💡
                    await userService.updateUser(userId, updateData);
                    showToast('تم تحديث المستخدم بنجاح', 'success');
                } else {
                    const newUser = { username, email, role, password }; // 💡💡💡 إرسال email 💡💡💡
                    await userService.addUser(newUser);
                    showToast('تمت إضافة المستخدم بنجاح', 'success');
                }
                closeUserModal();
                loadUsers();
            } catch (error) {
                showToast(error.message || 'حدث خطأ.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        changePasswordForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const userId = changePassUserIdInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (newPassword !== confirmNewPassword) {
                showToast('كلمتا المرور الجديدتان غير متطابقتين!', 'error');
                submitBtn.disabled = false;
                return;
            }

            try {
                await userService.changeUserPassword(userId, newPassword);
                showToast('تم تغيير كلمة المرور بنجاح', 'success');
                closeChangePasswordModal();
            } catch (error) {
                showToast(error.message || 'فشل في تغيير كلمة المرور.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });

        usersTableBody.addEventListener('click', async (event) => {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const id = button.dataset.id;
            const action = button.dataset.action;

            try {
                switch (action) {
                    case 'edit':
                        const userToEdit = await userService.getUserById(id);
                        openUserModal(userToEdit);
                        break;
                    case 'change-password':
                        openChangePasswordModal(id);
                        break;
                    case 'toggle-status':
                        const currentStatus = button.dataset.currentStatus === 'true'; // 💡💡💡 جلب الحالة الحالية 💡💡💡
                        await userService.toggleUserStatus(id, !currentStatus); // 💡💡💡 إرسال الحالة الجديدة 💡💡💡
                        showToast('تم تغيير حالة المستخدم بنجاح', 'success');
                        loadUsers();
                        break;
                    case 'delete':
                        openDeleteModal(id);
                        break;
                }
            } catch (error) {
                showToast(error.message || 'حدث خطأ.', 'error');
            }
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!userIdToDelete) return;
            try {
                await userService.deleteUser(userIdToDelete);
                showToast('تم حذف المستخدم بنجاح', 'success');
                closeDeleteModal();
                loadUsers();
            } catch (error) {
                showToast(error.message || 'فشل حذف المستخدم.', 'error');
            }
        });

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);

        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });
    </script>
</body>
</html>