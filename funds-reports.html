<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .report-controls-top {
            background-color: #fff; padding: 20px; border-radius: 10px;
            margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        .filters-layout {
            display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;
        }
        .filter-group { display: none; }
        .filter-group.active { display: flex; gap: 15px; align-items: flex-end; }
        .table-container th, .table-container td { text-align: center; }
        .subtotal-row th, .total-row th { background-color: #f8f9fa; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <div class="container">
                <h1>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</h1>
                <nav class="breadcrumb">
                    <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a> / <span>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</span>
                </nav>
            </div>
        </header>

        <main class="page-content">
            <div class="container">
                <div class="report-controls-top">
                    <div class="filters-layout">
                        <div class="form-group">
                            <label for="reportTypeSelect"><strong>Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong></label>
                            <select id="reportTypeSelect" class="form-control">
                                <option value="">-- Ø§Ø®ØªØ± --</option>
                                <option value="periodic">ØªÙ‚Ø±ÙŠØ± Ø¯ÙˆØ±ÙŠ</option>
                                <option value="annual">ØªÙ‚Ø±ÙŠØ± Ø³Ù†ÙˆÙŠ</option>
                            </select>
                        </div>

                        <div id="year-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="yearInput">Ø§Ù„Ø³Ù†Ø©:</label>
                                <input type="number" id="yearInput" class="form-control" value="2025" style="width: 100px;">
                            </div>
                        </div>
                        <div id="month-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="monthSelect">Ø§Ù„Ø´Ù‡Ø±:</label>
                                <select id="monthSelect" class="form-control">
                                    <option value="1">ÙŠÙ†Ø§ÙŠØ±</option> <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option> <option value="3">Ù…Ø§Ø±Ø³</option>
                                    <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option> <option value="5">Ù…Ø§ÙŠÙˆ</option> <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                                    <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option> <option value="8">Ø£ØºØ³Ø·Ø³</option> <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                                    <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option> <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option> <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                                </select>
                            </div>
                        </div>
                        <div id="cycle-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="fromCycleSelect">Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø©:</label>
                                <select id="fromCycleSelect" class="form-control">
                                    <option value="1">1</option> <option value="2">2</option> <option value="3">3</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="toCycleSelect">Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ±Ø©:</label>
                                <select id="toCycleSelect" class="form-control">
                                    <option value="1">1</option> <option value="2">2</option> <option value="3">3</option>
                                </select>
                            </div>
                        </div>
                        <div id="fund-filter-group" class="filter-group">
                            <div class="form-group">
                                <label for="fundSearchInput">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ù„ÙƒÙ„):</label>
                                <input type="text" id="fundSearchInput" class="form-control" list="funds-list" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
                                <datalist id="funds-list"></datalist>
                            </div>
                        </div>
                        
                        <button id="generateReportBtn" class="btn btn-primary" disabled><i class="fas fa-play-circle"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                        <button id="exportExcelBtn" class="btn btn-success" disabled><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
                    </div>
                </div>

                <section class="report-display">
                    <div class="table-container" id="reportResultContainer">
                        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±".</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="toast" class="toast-notification"><p id="toastMessage"></p></div>

    <script type="module">
        // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯Ø§Ù„Ø© getFunds ğŸ’¡ğŸ’¡ğŸ’¡
        import { generateFundReport, getFunds } from './assets/js/funds-reports-service.js';
        import { showToast } from './assets/js/utils.js';
        
        let currentReportData = [];
        let allFunds = [];

        const reportTypeSelect = document.getElementById('reportTypeSelect');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const reportResultContainer = document.getElementById('reportResultContainer');
        const fundSearchInput = document.getElementById('fundSearchInput');
        const fundsDatalist = document.getElementById('funds-list');

        async function initializePage() {
            try {
                // ğŸ’¡ğŸ’¡ğŸ’¡ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© getFunds Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ’¡ğŸ’¡ğŸ’¡
                allFunds = await getFunds(); 
                
                // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
                allFunds.forEach(f => {
                    const option = document.createElement('option');
                    option.value = `${f.name} (${f.fundCode})`;
                    option.dataset.id = f._id; // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§
                    fundsDatalist.appendChild(option);
                });
            } catch (error) {
                showToast(error.message, 'error');
            }
            // Set current year and month for filters
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('yearInput').value = currentYear;
            document.getElementById('monthSelect').value = currentMonth;
        }

        function updateVisibleFilters() {
            const selectedReport = reportTypeSelect.value;
            document.querySelectorAll('.filter-group').forEach(group => group.classList.remove('active'));
            generateReportBtn.disabled = !selectedReport;

            if (!selectedReport) return;

            if (selectedReport === 'periodic') {
                ['year-filter-group', 'month-filter-group', 'cycle-filter-group'].forEach(id => document.getElementById(id).classList.add('active'));
            } else if (selectedReport === 'annual') {
                ['year-filter-group', 'fund-filter-group'].forEach(id => document.getElementById(id).classList.add('active'));
            }
        }

        async function handleGenerateReport() {
            const reportType = reportTypeSelect.value;
            if (!reportType) return;

            const filters = { year: document.getElementById('yearInput').value };
            if (reportType === 'periodic') {
                filters.month = document.getElementById('monthSelect').value;
                filters.fromCycle = parseInt(document.getElementById('fromCycleSelect').value);
                filters.toCycle = parseInt(document.getElementById('toCycleSelect').value);
                if (filters.fromCycle > filters.toCycle) return showToast('"Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø©" ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ØµØºØ± Ù…Ù† Ø£Ùˆ ØªØ³Ø§ÙˆÙŠ "Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ±Ø©"', 'error');
            } else if (reportType === 'annual') {
                const selectedValue = fundSearchInput.value;
                const selectedFund = allFunds.find(f => `${f.name} (${f.fundCode})` === selectedValue);
                filters.fundId = selectedFund ? selectedFund._id : null;
            }
            
            reportResultContainer.innerHTML = `<div class="loader"></div>`;
            generateReportBtn.disabled = true;
            exportExcelBtn.disabled = true;

            try {
                currentReportData = await generateFundReport(reportType, filters);
                renderReport(reportType, currentReportData);
                exportExcelBtn.disabled = false;
            } catch (error) {
                reportResultContainer.innerHTML = `<p class="error-message">${error.message}</p>`;
            } finally {
                generateReportBtn.disabled = false;
            }
        }

        function renderReport(reportType, data) {
            reportResultContainer.innerHTML = '';
            if (reportType === 'periodic') {
                if (!data || data.length === 0) {
                    reportResultContainer.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</p>'; return;
                }

                // --- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ ---
                const grandTotal = { openingBalance: 0, assignmentCount: 0, totalCollection: 0, totalDeposit: 0, netAmount: 0 };

                data.forEach(cycleData => {
                    const table = document.createElement('table');
                    table.className = 'data-table';
                    table.innerHTML = `
                        <caption><strong>${cycleData.title}</strong></caption>
                        <thead><tr><th>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù†Ø§Ø¯</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙˆØ±ÙŠØ¯</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
                        <tbody>
                            ${cycleData.rows.map(row => `
                                <tr>
                                    <td>${row.fundName}</td> <td>${row.openingBalance.toLocaleString('en-US')}</td>
                                    <td>${row.totalCollection.toLocaleString('en-US')}</td> <td>${row.assignmentCount}</td>
                                    <td>${row.totalDeposit.toLocaleString('en-US')}</td> <td>${row.netAmount.toLocaleString('en-US')}</td>
                                    <td>${row.notes}</td>
                                </tr>`).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="subtotal-row">
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ù„Ø¯ÙˆØ±Ø©</th> 
                                <th>${cycleData.subTotal.openingBalance.toLocaleString('en-US')}</th>
                                <th>${cycleData.subTotal.totalCollection.toLocaleString('en-US')}</th> <th>${cycleData.subTotal.assignmentCount}</th>
                                <th>${cycleData.subTotal.totalDeposit.toLocaleString('en-US')}</th> <th>${cycleData.subTotal.netAmount.toLocaleString('en-US')}</th>
                                <th></th>
                            </tr>
                        </tfoot>`;
                    reportResultContainer.appendChild(table);

                    // --- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ ---
                    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ Ù„Ø§ ÙŠØªÙ… Ø¬Ù…Ø¹Ù‡ ÙÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ
                    grandTotal.assignmentCount += cycleData.subTotal.assignmentCount;
                    grandTotal.totalCollection += cycleData.subTotal.totalCollection;
                    grandTotal.totalDeposit += cycleData.subTotal.totalDeposit;
                    grandTotal.netAmount += (cycleData.subTotal.totalCollection - cycleData.subTotal.totalDeposit);
                });

                // --- Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ø¹Ø±Ø¶ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø¯ÙˆØ±Ø© ---
                if (data.length > 1) {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ Ø§Ù„Ø£ÙˆÙ„ ÙˆØµØ§ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                    const firstCycleOpeningBalance = data[0].subTotal.openingBalance;
                    const finalNetAmount = firstCycleOpeningBalance + grandTotal.netAmount;

                    const totalTable = document.createElement('table');
                    totalTable.className = 'data-table';
                    totalTable.innerHTML = `
                        <tfoot>
                            <tr class="total-row" style="border-top: 3px double black;">
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„ÙØªØ±Ø©</th> 
                                <th>${firstCycleOpeningBalance.toLocaleString('en-US')}</th>
                                <th>${grandTotal.totalCollection.toLocaleString('en-US')}</th> 
                                <th>${grandTotal.assignmentCount}</th>
                                <th>${grandTotal.totalDeposit.toLocaleString('en-US')}</th> 
                                <th>${finalNetAmount.toLocaleString('en-US')}</th>
                                <th></th>
                            </tr>
                        </tfoot>`;
                    reportResultContainer.appendChild(totalTable);
                }

            } else if (reportType === 'annual') {
                if (!data || !data.monthlyData || data.monthlyData.length === 0) {
                    reportResultContainer.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©.</p>'; return;
                }
                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `
                    <thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯</th><th>ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù†Ø§Ø¯</th><th>Ø§Ù„Ø£Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©</th></tr></thead>
                    <tbody>
                        ${data.monthlyData.map(month => `
                            <tr>
                                <td>${month.month}</td> <td>${month.totalCollection.toLocaleString('en-US')}</td>
                                <td>${month.totalDeposit.toLocaleString('en-US')}</td> <td>${month.netAmount.toLocaleString('en-US')}</td>
                                <td>${month.receiptCount}</td> <td>${month.missingCount}</td>
                            </tr>`).join('')}
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ</th> <th>${data.totals.totalCollection.toLocaleString('en-US')}</th>
                            <th>${data.totals.totalDeposit.toLocaleString('en-US')}</th> <th>${data.totals.netAmount.toLocaleString('en-US')}</th>
                            <th>${data.totals.receiptCount}</th> <th>${data.totals.missingCount}</th>
                        </tr>
                    </tfoot>`;
                reportResultContainer.appendChild(table);
            }
        }
        function handleExport() {
            if (!currentReportData || currentReportData.length === 0 || (currentReportData.monthlyData && currentReportData.monthlyData.length === 0)) { // Added check for annual report data
                return showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.', 'warning');
            }

            const reportType = reportTypeSelect.value;
            const year = document.getElementById('yearInput').value;
            const monthIndex = document.getElementById('monthSelect').value - 1;
            const monthName = new Date(year, monthIndex).toLocaleString('ar-SA', { month: 'long' });
            
            let dataToExport = [];
            let reportTitleText = '';

            if (reportType === 'periodic') {
                const fromCycle = document.getElementById('fromCycleSelect').value;
                const toCycle = document.getElementById('toCycleSelect').value;
                reportTitleText = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ - ${monthName} ${year} (Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø© ${fromCycle} Ø¥Ù„Ù‰ ${toCycle})`;

                const grandTotal = { assignmentCount: 0, totalCollection: 0, totalDeposit: 0 };
                
                currentReportData.forEach(cycleData => {
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯ÙˆØ±Ø©
                    dataToExport.push({ 'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚': cycleData.title });
                    // Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©
                    cycleData.rows.forEach(row => {
                        dataToExport.push({
                            'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚': row.fundName,
                            'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': row.openingBalance,
                            'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„': row.totalCollection,
                            'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù†Ø§Ø¯': row.assignmentCount,
                            'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙˆØ±ÙŠØ¯': row.totalDeposit,
                            'ØµØ§ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯': row.netAmount
                        });
                    });
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ù„Ø¯ÙˆØ±Ø©
                    const sub = cycleData.subTotal;
                    dataToExport.push({
                        'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ù„Ø¯ÙˆØ±Ø©',
                        'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': sub.openingBalance,
                        'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„': sub.totalCollection,
                        'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù†Ø§Ø¯': sub.assignmentCount,
                        'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙˆØ±ÙŠØ¯': sub.totalDeposit,
                        'ØµØ§ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯': sub.netAmount
                    });
                    dataToExport.push({}); // ØµÙ ÙØ§Ø±Øº Ù„Ù„ÙØµÙ„

                    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ
                    grandTotal.assignmentCount += sub.assignmentCount;
                    grandTotal.totalCollection += sub.totalCollection;
                    grandTotal.totalDeposit += sub.totalDeposit;
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø¯ÙˆØ±Ø©
                if (currentReportData.length > 1) {
                    const firstCycleOpeningBalance = currentReportData[0].subTotal.openingBalance;
                    const finalNetAmount = firstCycleOpeningBalance + (grandTotal.totalCollection - grandTotal.totalDeposit);
                    dataToExport.push({
                        'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„ÙØªØ±Ø©',
                        'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ': firstCycleOpeningBalance,
                        'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„': grandTotal.totalCollection,
                        'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù†Ø§Ø¯': grandTotal.assignmentCount,
                        'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙˆØ±ÙŠØ¯': grandTotal.totalDeposit,
                        'ØµØ§ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯': finalNetAmount
                    });
                }

            } else if (reportType === 'annual') {
                reportTitleText = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ - ${year}`;
                dataToExport = currentReportData.monthlyData.map(row => ({
                    'Ø§Ù„Ø´Ù‡Ø±': row.month,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„': row.totalCollection,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯': row.totalDeposit,
                    'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº': row.netAmount,
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù†Ø§Ø¯': row.receiptCount,
                    'Ø§Ù„Ø£Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©': row.missingCount
                }));
                // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ
                const totals = currentReportData.totals;
                dataToExport.push({}); // ØµÙ ÙØ§Ø±Øº
                dataToExport.push({
                    'Ø§Ù„Ø´Ù‡Ø±': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ',
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„': totals.totalCollection,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯': totals.totalDeposit,
                    'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº': totals.netAmount,
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù†Ø§Ø¯': totals.receiptCount,
                    'Ø§Ù„Ø£Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©': totals.missingCount
                });
            }

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
            XLSX.utils.sheet_add_aoa(ws, [[reportTitleText]], { origin: 'A1' });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, `Funds_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initializePage);
        reportTypeSelect.addEventListener('change', updateVisibleFilters);
        generateReportBtn.addEventListener('click', handleGenerateReport);
        exportExcelBtn.addEventListener('click', handleExport); // To be implemented
    </script>
</body>
</html>